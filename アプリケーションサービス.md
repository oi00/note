# アプリケーションサービス
## アプリケーションサービスとは  
ユースケースを実現するサービス  
ユースケースとは自動化されたシステムを使用する方法を記述したものである。  
例えばユーザ登録画面のようなものがあったとして  
「ユーザを登録する」、「ユーザ情報を変更する」  のようなユースケースが必要となる。   
これらをドメインオブジェクトを組み合わせてふるまいとして実装するのがアプリケーションサービスになる。  
## ドメインサービスとアプリケーションサービス  
サービスとは、クライアントのために何かを行うモノ(活動や行動)である。  
サービスは自身のためのふるまいを持たない⇔値オブジェクトやエンティティは自身のためのふるまいを持つ  
ドメインにおける活動⇒ドメインサービス  
アプリケーションとして成り立たせるためのサービス⇒アプリケーションサービス

## 実装例  
以下のユースケースを実装する例  
- ユーザを登録する
- ユーザ情報を確認する
- ユーザ情報を更新する
- 退会(ユーザ情報を削除)する
```c#:tite
/// ユーザのエンティティ
Publiv Class User
{
    Public User(UserName name)
    {
        Id = new UserId(Guid.NewGuid().ToString());
        Name = name;
    }

    /// 再構築用のコンストラクタ
    Public User(UserId id, UserName name)
    {
        Id = id;
        Name = name;
    }

    Public UserId Id {get;}
    Public UserName Name {get; private set;}

    public void ChangeName(UserName name)
    {
        Name = name;
    }
}
```
```c#:tite
/// ユーザのエンティティが利用している値オブジェクト
Public Class UserId
{
    public UserId(string value) 
    { 
        if (string. IsNullOrEmpty(value)) throw new ArgumentException(" value がnullまたは空文字です"); 
        Value = value; 
    } 
    public string Value { get; }
}
public class UserName 
{ 
    public UserName(string value) 
    { 
        //　ユーザ名に関するチェック処理は、ユーザ名の値オブジェクト内で行う
        if (value == null) throw newArgumentNullException(nameof( value)); 
        if (value.Length < 3) throw new ArgumentException("ユーザ名は3文字以上です。", nameof(value)); 
        if (value.Length > 20) throw new ArgumentException("ユーザ名は20 文字以下です。", nameof(value)); 
        Value = value; 
    } 
    public string Value { get; } 
}
```
```c#:title
/// ユーザのドメインサービス
public class UserService 
{ 
    private readonly IUserRepository userRepository; 
    public UserService(IUserRepository userRepository) 
    { 
        this. userRepository = userRepository; 
    } 
    public bool Exists(User user) 
    { 
        // リポジトリで行うのはあくまで、取得、登録、削除のみ
        // 取得したデータで何かをしたい場合の処理はドメインサービスに記述する
        var duplicatedUser = userRepository.Find(user.Name);
        return duplicatedUser != null; 
    } 
}
```
```c#:title
/// ユーザのリポジトリ
public interface IUserRepository 
{ 
    User Find(UserId id); 
    User Find(UserName name);
    void Save(User user);
    void Delete(User user);
}
```
```c#:title
/// アプリケーションサービス
public class UserApplicationService 
{ 
    private readonly IUserRepository userRepository; 
    private readonly UserService userService; 
    public UserApplicationService(IUserRepository userRepository, UserService userService) 
    { 
        this.userRepository = userRepository; 
        this.userService = userService; 
    }
    // ユーザを登録する
    public void Register(string name) 
    { 
        // ドメインオブジェクト、ドメインサービスを呼び出してユースケースを実装する
        var user = new User(new UserName(name)); 
        if (userService.Exists(user)) 
        { 
            throw new CanNotRegisterUserException(user, "ユーザは既に存在しています。"); 
        } 
        userRepository.Save(user); 
    }
    // ユーザ情報を確認する
    // Userエンティティではなく、そのDTOのUserDataを返す
    public UserData Get(string userId)
    { 
        var targetId = new UserId(userId); 
        var user = userRepository.Find(targetId);
        if (user == null) 
        { 
            return null; 
        } 
        return new UserData(user);
    }
    // ユーザ情報を更新する
    // 更新情報は
    // ・Userエンティティを引数で受け取る→エンティティを外部に公開したくない
    // ・各属性を引数で受け取る→属性が増えたときに変更箇所が多くなる
    // ため、コマンドオブジェクトとして受け取る。
    public void Update(UserUpdateCommand command)
    {
        var targetId = new UserId(commnad.Id);
        var user = userRepository.Find(targetId);
        if (user == null)
        {
            throw new UserNotFoundException(targetId);
        }
        var name = command.Name; 
        if (name != null) 
        { 
            var newUserName = new UserName( name); 
            user. ChangeName( newUserName); 
            if (userService.Exists(user)) 
            { 
                throw new CanNotRegisterUserException(user, "ユーザは既に存在しています。"); 
            } 
        }
        userRepository.Save(user);
    }
    // 退会(ユーザ情報を削除)する
    public void Delete(UserDeleteCommand command)
    { 
        var targetId = new UserId(command.Id); 
        var user = userRepository.Find(targetId); 
        if (user == null) 
        { 
            throw new UserNotFoundException(targetId); 
        } 
            userRepository.Delete(user); 
    }
}
```
```c#:title
/// UserエンティティのDTO
/// アプリケーションクラスを使うクラスにUserエンティティが公開されるのを防ぐため
public class UserData 
{ 
    public UserData(User source) 
    { 
        Id = source.Id.Value; 
        Name = source.Name.Value;
    }
    /// 情報を取得することしかできなくし、ChangeNameのようなふるまいはアプリケーションサービスを経由して行わせるようにする
    public string Id { get; } 
    public string Name { get; }
}
```
```c#:title
/// Userを更新する際のコマンドオブジェクト
public class UserUpdateCommand
{
    public UserUpdateCommand(string id)
    {
        Id = id;
    }
    public string Id {get;}
    /// 変更したい項目を設定する
    public String Name {get; set;}
}
```
